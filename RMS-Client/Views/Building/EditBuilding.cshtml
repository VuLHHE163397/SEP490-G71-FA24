@model RMS_API.DTOs.BuildingDTO

@{
    ViewData["Title"] = "Chỉnh sửa Tòa Nhà"; // Page title
}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RMS</title>
    <link rel="shortcut icon" type="image/png" href="~/images/logos/favicon.png" />
    <link rel="stylesheet" href="~/css/styles.min.css" />
</head>

<body>
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
         data-sidebar-position="fixed" data-header-position="fixed">
        <aside class="left-sidebar">
            <!-- Sidebar content here -->
        </aside>

        <div class="body-wrapper">
            <header class="app-header">
                <!-- Header content here -->
            </header>

            <div class="container-fluid">
                <div class="container mt-4">
                    <h1>@ViewData["Title"]</h1>

                    <form id="editBuildingForm" method="post" asp-action="EditBuilding" asp-controller="Building">
                        <input type="hidden" name="Id" value="@Model.Id" />

                        <div class="form-group">
                            <label for="Name">Tên Tòa Nhà</label>
                            <input type="text" class="form-control" id="Name" name="Name" value="@Model.Name" required />
                        </div>
                        <div class="form-group">
                            <label for="TotalFloors">Số Tầng</label>
                            <input type="number" class="form-control" id="TotalFloors" name="TotalFloors" value="@Model.TotalFloors" required />
                        </div>
                        <div class="form-group">
                            <label for="NumberOfRooms">Số Phòng</label>
                            <input type="number" class="form-control" id="NumberOfRooms" name="NumberOfRooms" value="@Model.NumberOfRooms" required />
                        </div>
                        <div class="form-group">
                            <label for="ProvinceId">Tỉnh</label>
                            <select class="form-control" id="ProvinceId" name="ProvinceName" required>
                                <option value="">Chọn Tỉnh/Thành phố</option>
                                @foreach (var province in ViewBag.Provinces)
                                {
                                    <option value="@province.Name">@province.Name</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="DistrictId">Quận</label>
                            <select class="form-control" id="DistrictId" name="DistrictName" required>
                                <option value="">Chọn Quận</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="WardId">Xã</label>
                            <select class="form-control" id="WardId" name="WardName" required>
                                <option value="">Chọn Xã</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="BuildingStatus">Trạng Thái</label>
                            <select class="form-control" id="BuildingStatus" name="BuildingStatus" required>
                                @foreach (var status in ViewBag.BuildingStatuses)
                                {
                                    <option value="@status.Name">@status.Name</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="AddressDetails">Địa Chỉ</label>
                            <input type="text" class="form-control" id="AddressDetails" name="AddressDetails" value="@Model.AddressDetails" required />
                        </div>
                        <button type="submit" class="btn btn-primary">Cập Nhật Tòa Nhà</button>
                        <a asp-controller="Building" asp-action="ListBuilding" class="btn btn-secondary">Trở Về</a>
                    </form>
                </div>

                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                <script>
                    $(document).ready(function () {
                        
                        function getBuildingById(buildingId) {
                            var url = `https://localhost:5001/api/Building/GetBuildingById/${id}`;

                            $.ajax({
                                url: url,
                                type: 'GET',
                                success: function (data) {
                                    // Populate the form fields with the data received
                                    $('#Name').val(data.name);
                                    $('#TotalFloors').val(data.totalFloors);
                                    $('#NumberOfRooms').val(data.numberOfRooms);
                                    $('#ProvinceId').val(data.provinceName).change();
                                    $('#DistrictId').val(data.districtName).change(); 
                                    $('#WardId').val(data.wardName);
                                    $('#AddressDetails').val(data.addressDetails);
                                    $('#BuildingStatus').val(data.buildingStatus);
                                },
                                error: function (xhr) {
                                    alert('Error: ' + xhr.responseText);
                                }
                            });
                        }

                        // Get the building ID from the URL (assuming it is part of the route)
                        var buildingId = new URLSearchParams(window.location.search).get('id');
                        if (buildingId) {
                            getBuildingById(buildingId);
                        }

                        // Populate the districts based on selected province
                        $('#ProvinceId').change(function () {
                            var provinceName = encodeURIComponent($(this).val());
                            var url = `https://localhost:5001/api/Building/GetDistrictsByProvince/${provinceName}`;

                            if (provinceName) {
                                $.ajax({
                                    url: url,
                                    type: 'GET',
                                    success: function (data) {
                                        $('#DistrictId').empty().append('<option value="">Chọn Quận</option>');
                                        data.forEach(function (district) {
                                            $('#DistrictId').append(`<option value="${district.Name}">${district.Name}</option>`);
                                        });
                                    }
                                });
                            }
                        });

                        $('#DistrictId').change(function () {
                            var districtName = encodeURIComponent($(this).val());
                            var url = `https://localhost:5001/api/Building/GetWardsByDistrict/${districtName}`;

                            if (districtName) {
                                $.ajax({
                                    url: url,
                                    type: 'GET',
                                    success: function (data) {
                                        $('#WardId').empty().append('<option value="">Chọn Xã</option>');
                                        data.forEach(function (ward) {
                                            $('#WardId').append(`<option value="${ward.Name}">${ward.Name}</option>`);
                                        });
                                    }
                                });
                            }
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</body>

</html>
