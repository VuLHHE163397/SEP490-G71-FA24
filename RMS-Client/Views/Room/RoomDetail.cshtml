@using RMS_API.Models
@model Room

@{
    ViewBag.Title = "Chi Tiết Phòng";
}
@{
    var buildingId = ViewBag.BuildingId; // Lấy BuildingId từ phòng đầu tiên, nếu có
}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RMS</title>
    <link rel="shortcut icon" type="image/png" href="~/images/logos/favicon.png" />
    <link rel="stylesheet" href="~/css/styles.min.css" />
    <style>

        #file-input,
        #upload-button {
            margin-top: 20px; /* Thêm khoảng cách từ phần tử trên */
        }

        div {
            margin-top: 20px; /* Thêm khoảng cách cho div chứa input và button */
        }


        .image-gallery {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 500px; /* Đảm bảo container chính không bị quá lớn */
            margin: 0 auto;
        }

        .main-image {
            width: 100%;
            max-width: 500px;
            margin-bottom: 10px;
        }

            .main-image img {
                width: 100%;
                border-radius: 5px;
            }

        .thumbnail-container {
            display: flex; /* Sử dụng flexbox để hiển thị các hình theo chiều ngang */
            /* overflow-x: auto; */ /* Thêm thanh cuộn ngang nếu các ảnh vượt quá kích thước container */
            gap: 10px; /* Khoảng cách giữa các ảnh */
        }

            .thumbnail-container .thumbnail {
                width: 80px;
                height: 80px;
                cursor: pointer;
                border-radius: 5px;
                object-fit: cover;
                transition: transform 0.2s;
            }

                .thumbnail-container .thumbnail:hover {
                    transform: scale(1.1);
                }

        .thumbnail-item {
            position: relative;
            flex-shrink: 0;
        }

        .delete-button {
            position: absolute;
            top: -2px; /* Khoảng cách từ cạnh trên của ảnh */
            right: -2px; /* Khoảng cách từ cạnh phải của ảnh */
            font-size: 24px; /* Kích thước hình trái tim */
            color: red; /* Màu của hình trái tim */
            cursor: pointer; /* Thêm hiệu ứng khi hover */
        }

            .delete-button:hover {
                color: darkred; /* Màu khi hover */
            }

        .map-container {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            height: 450px;
        }

        /* Sidebar styling */
        .sidebar-submenu {
            padding-left: 15px;
            display: none;
        }

        .sidebar-sublink {
            color: #6c757d;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

            .sidebar-sublink:hover {
                color: #0d6efd;
            }

        /* Sidebar arrow rotation */
        .rotate {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }

        /* Table styling */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Button styles */
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
        }

        /* Page wrapper styles */
        .page-wrapper {
            display: flex;
        }

        /* Main content area padding */
        .body-wrapper {
            padding: 20px;
            flex-grow: 1;
        }

        /* Header navbar icon */
        .nav-icon-hover {
            cursor: pointer;
        }

        /* Profile image in dropdown */
        .navbar-nav .dropdown-menu img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .room-details img {
            width: 600px;
            height: 400px;
        }

    </style>
</head>

<body>

    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
         data-sidebar-position="fixed" data-header-position="fixed">

        <aside class="left-sidebar">

            <div>
                <div class="brand-logo d-flex align-items-center justify-content-between">
                    <a asp-controller="Building" asp-action="ListBuilding" class="text-nowrap logo-img">
                        <img src="~/images/logo.jpg" width="180" alt="" />
                    </a>
                    <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                        <i class="ti ti-x fs-8"></i>
                    </div>
                </div>

                <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                    <ul id="sidebarnav">
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Trang chủ</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Building" asp-action="ListBuilding">
                                <span><i class="ti ti-layout-dashboard"></i></span>
                                <span class="hide-menu">Trang chủ</span>
                            </a>
                        </li>
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Quản lý</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="#" aria-expanded="false" onclick="toggleSubmenu(event)">
                                <span><i class="ti ti-layout-dashboard"></i></span>
                                <span class="hide-menu">Quản lý phòng</span>
                                <span><i class="ti ti-chevron-down"></i></span>
                            </a>
                            <ul class="sidebar-submenu" style="display: block; list-style-type: none; padding-left: 20px;">
                                @{
                                    var buildingsss = ViewBag.Buildings as List<RMS_API.Models.Building>;
                                }
                                @if (buildingsss != null && buildingsss.Any())
                                {
                                    foreach (var buildingss in buildingsss)
                                    {
                                        <li class="sidebar-subitem">
                                            <a asp-controller="Room" asp-action="ListRoom" asp-route-buildingId="@buildingss.Id" class="sidebar-sublink">
                                                <i class="ti ti-file"></i>
                                                @buildingss.Name
                                            </a>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li class="sidebar-subitem">Không có tòa nhà nào</li>
                                }
                            </ul>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Facility" asp-action="ListFacility" aria-expanded="false">
                                <span>
                                    <i class="ti ti-alien"></i>
                                </span>
                                <span class="hide-menu">Cơ sở vật chất</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Service" asp-action="ListService" aria-expanded="false">
                                <span>
                                    <i class="ti ti-menu"></i>
                                </span>
                                <span class="hide-menu">Dịch vụ</span>
                            </a>
                        </li>

                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./ui-typography.html" aria-expanded="false">
                                <span>
                                    <i class="ti ti-report"></i>
                                </span>
                                <span class="hide-menu">Danh sách yêu cầu</span>
                            </a>
                        </li>
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">-------------------------</span>
                        </li>

                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./authentication-register.html" aria-expanded="false">
                                <span>
                                    <i class="ti ti-user-plus"></i>
                                </span>
                                <span class="hide-menu">Register</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./authentication-login.html" aria-expanded="false">
                                <span>
                                    <i class="ti ti-login"></i>
                                </span>
                                <span class="hide-menu">Đăng xuất</span>
                            </a>
                        </li>
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">EXTRA</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./icon-tabler.html" aria-expanded="false">
                                <span>
                                    <i class="ti ti-mood-happy"></i>
                                </span>
                                <span class="hide-menu">Icons</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./sample-page.html" aria-expanded="false">
                                <span>
                                    <i class="ti ti-aperture"></i>
                                </span>
                                <span class="hide-menu">Sample Page</span>
                            </a>
                        </li>
                    </ul>
                    <div class="unlimited-access hide-menu bg-light-primary position-relative mb-7 mt-5 rounded">
                        <div class="d-flex">
                            <div class="unlimited-access-title me-3">
                                <h6 class="fw-semibold fs-4 mb-6 text-dark w-85">Upgrade to pro</h6>
                                <a href="https://adminmart.com/product/modernize-bootstrap-5-admin-template/" target="_blank"
                                   class="btn btn-primary fs-2 fw-semibold lh-sm">Buy Pro</a>
                            </div>
                            <div class="unlimited-access-img">
                                <img src="~/images/backgrounds/rocket.png" alt="" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </nav>

            </div>

        </aside>

        <div class="body-wrapper">

            <header class="app-header">
                @* <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                <li class="nav-item d-block d-xl-none">
                <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                <i class="ti ti-menu-2"></i>
                </a>
                </li>
                <li class="nav-item">
                <a class="nav-link nav-icon-hover" asp-controller="Room" asp-action="ListRoom" asp-route-buildingId="@buildingId">
                <i class="ti ti-arrow-back" style="font-size: 30px;"></i>
                </a>
                <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                <i class="ti ti-bell-ringing"></i>
                <div class="notification bg-primary rounded-circle"></div>
                </a>
                </li>
                </ul>
                <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="~/images/profile/user-1.jpg" alt="" width="50" height="50" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                <div class="message-body">
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                <i class="ti ti-user fs-6"></i>
                <p class="mb-0 fs-3">My Profile</p>
                </a>
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                <i class="ti ti-mail fs-6"></i>
                <p class="mb-0 fs-3">My Account</p>
                </a>
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                <i class="ti ti-list-check fs-6"></i>
                <p class="mb-0 fs-3">My Task</p>
                </a>
                <a href="./authentication-login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                </div>
                </div>
                </li>
                </ul>
                </div>

                </nav> *@
            </header>

            <div class="container-fluid">
                <div class="container">
                    <div class="text-center wow fadeInUp mb-5">
                        <h1>Chi Tiết Phòng @Model.RoomNumber </h1>
                    </div>
                    <div class="row g-4">
                        <div class="image-gallery">
                            <div class="main-image">
                                @{
                                    var images = ViewBag.Images as List<RMS_API.Models.Image>;
                                }
                                @if (images != null && images.Any())
                                {
                                    <img src="@images[0].Link" alt="Main Room Image" id="displayed-image">
                                }
                            </div>

                            <div class="thumbnail-container slick-carousel">
                                @if (images != null && images.Any())
                                {
                                    @for (int i = 0; i < images.Count; i++)
                                    {
                                        <div class="thumbnail-item position-relative" style="position: relative;">
                                            <img src="@images[i].Link" alt="Room Image" class="thumbnail" onclick="changeImage(this)">
                                            <i class="delete-button ti ti-circle-x" data-id="@images[i].Id" onclick="deleteImage(@images[i].Id)"></i>
                                        </div>

                                    }
                                }
                            </div>
                            <div>
                                <input type="file" id="file-input" />
                                <button type="button" id="upload-button" onclick="uploadImage()">Upload</button>
                            </div>


                        </div>
                        <div class="">Đặc điểm Phòng</div>
                        <div class="container"></div>
                        <div><strong>Giá:</strong> @string.Format("{0:N0} VNĐ", Model.Price)</div>
                        <div><strong>Diện tích:</strong> @Model.Area.ToString("0") m²</div>
                        @{
                            var facilities = ViewBag.Facilities as List<RMS_API.Models.Facility>;
                        }

                        @if (facilities != null && facilities.Any())
                        {
                            <div>
                                <strong>Cơ sở vật chất: </strong>
                                @for (int i = 0; i < facilities.Count; i++)
                                {
                                    <span>@facilities[i].Name</span>
                                    @if (i < facilities.Count - 1)
                                    {
                                        <span>, </span>
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            <div class="sidebar-subitem">
                                <strong>Cơ sở vật chất: </strong> Hiện tại chưa có cơ sở vật chất nào!
                            </div>
                        }

                        <p>
                            <strong>Trạng thái phòng:</strong>
                            @{
                                string statusNameVi;
                                switch (Model.RoomStatusId)
                                {
                                    case 1:
                                        statusNameVi = "Trống";
                                        break;
                                    case 2:
                                        statusNameVi = "Đã có người";
                                        break;
                                    case 3:
                                        statusNameVi = "Đang sửa chữa";
                                        break;
                                    case 4:
                                        statusNameVi = "Sắp trống";
                                        break;
                                    default:
                                        statusNameVi = @Model.RoomStatusId.ToString();
                                        break;
                                }
                            }
                            @statusNameVi
                        </p>
                        <p><strong>Mô tả chi tiết:</strong> @Model.Description</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            // Khởi tạo slick cho container ảnh nhỏ
            $('.slick-carousel').slick({
                slidesToShow: 4,
                slidesToScroll: 1,
                arrows: true,
                dots: false,
                centerMode: true,       // Căn giữa ảnh trong carousel
                focusOnSelect: true,    // Cho phép chọn ảnh khi nhấn vào thumbnail
                variableWidth: true     // Tự điều chỉnh kích thước để tránh tràn
            });
        });

        // Hàm thay đổi hình ảnh lớn khi nhấn vào thumbnail
        function changeImage(element) {
            document.getElementById("displayed-image").src = element.src;
        }


        function toggleSubmenu(event) {
            event.preventDefault();
            var submenu = event.currentTarget.nextElementSibling;
            submenu.style.display = submenu.style.display === "none" ? "block" : "none";
        }

        function deleteImage(imageId) {
            if (confirm("Bạn chắc chắn muốn xóa ảnh này?")) {
                fetch(`/api/Room/DeleteImageById/${imageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // Xóa ảnh trên giao diện
                            var imageElement = document.querySelector(`[data-id='${imageId}']`).closest('.thumbnail-item');
                            imageElement.remove();
                            alert("Ảnh đã được xóa.");
                            // Nếu muốn có thể tải lại trang sau khi xóa ảnh
                            location.reload();
                        } else {
                            response.json().then(data => {
                                alert("Có lỗi xảy ra khi xóa ảnh: " + (data.message || ''));
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("Có lỗi xảy ra khi kết nối với server.");
                    });
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const roomId = @Model.Id; // Thay bằng RoomId tương ứng nếu RoomId có sẵn trong ViewModel

            if (!file) {
                alert("Please select a file.");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            try {
                // Sửa lại cú pháp URL với backticks
                const response = await fetch(`/api/Room/upload-image/${roomId}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("Failed to upload image.");
                }

                const data = await response.json();
                alert("Image uploaded successfully!");

                // Bạn có thể thêm ảnh vào gallery mà không cần phải tải lại trang
                const imageContainer = document.querySelector(".thumbnail-container");
                const newImageElement = document.createElement("div");
                newImageElement.classList.add("thumbnail-item");
                newImageElement.innerHTML = `<img src="${data.imageUrl}" alt="Room Image" class="thumbnail">`;
                imageContainer.appendChild(newImageElement);
            } catch (error) {
                console.error(error);
                alert("An error occurred while uploading the image.");
            }
        }

    </script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

</body>
</html>