@model List<RMS_API.DTOs.ServiceDTO>
@{
    ViewData["Title"] = "Tính chỉ số điện"; // Page title
}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RMS</title>
    <link rel="shortcut icon" type="image/png" href="~/images/logos/favicon.png" />
    <link rel="stylesheet" href="~/css/styles.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>

        /* Sidebar styling */
        .sidebar-submenu {
            padding-left: 15px;
            display: none;
        }

        .sidebar-sublink {
            color: #6c757d;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

            .sidebar-sublink:hover {
                color: #0d6efd;
            }

        /* Sidebar arrow rotation */
        .rotate {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }

        /* Table styling */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Button styles */
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
        }

        /* Page wrapper styles */
        .page-wrapper {
            display: flex;
        }

        /* Main content area padding */
        .body-wrapper {
            /* padding: 20px; */
            flex-grow: 1;
        }

        /* Header navbar icon */
        .nav-icon-hover {
            cursor: pointer;
        }

        /* Profile image in dropdown */
        .navbar-nav .dropdown-menu img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <script>
        function getCookie(name) {
            const cookieString = document.cookie.split('; ').find(row => row.startsWith(`${name}=`));
            return cookieString ? decodeURIComponent(cookieString.split('=')[1]) : null;
        }

        const token = getCookie('AuthToken');
        if (!token) {
            console.error('Token không tìm thấy trong cookie.');
        }
        const tokenParts = token.split('.');
        const payload = JSON.parse(atob(tokenParts[1]));
        if (payload.Roles !== "Landlord") {
            window.location.href = "/Auth/login";
        }

        function logout() {
            document.cookie = "AuthToken=; path=/; expires=Sun, 01 Jan 1111 00:00:00 UTC; SameSite=None; Secure";
            window.location.href = "/Auth/Login";
        }

    </script>
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
         data-sidebar-position="fixed" data-header-position="fixed">

        <aside class="left-sidebar">

            <div>
                <div class="brand-logo d-flex align-items-center justify-content-between">
                    <a asp-controller="Statistic" asp-action="ViewStatistic" class="text-nowrap logo-img">
                        <img src="~/images/logo.jpg" width="180" alt="" />
                    </a>
                    <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                        <i class="ti ti-x fs-8"></i>
                    </div>
                </div>

                <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                    <ul id="sidebarnav">
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Trang chủ</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Building" asp-action="ListBuilding">
                                <span><i class="ti ti-layout-dashboard"></i></span>
                                <span class="hide-menu">Trang chủ</span>
                            </a>
                        </li>
                        <li class="nav-small-cap">
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Quản lý</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="#" aria-expanded="false" onclick="toggleSubmenu(event)">
                                <span><i class="ti ti-home"></i></span>
                                <span class="hide-menu">Quản lý phòng</span>
                                <span><i class="ti ti-chevron-down"></i></span>
                            </a>
                            <ul class="sidebar-submenu" style="display: block; list-style-type: none; padding-left: 20px;">
                                @{
                                    var buildingsss = ViewBag.Buildings as List<RMS_API.Models.Building>;
                                }
                                @if (buildingsss != null && buildingsss.Any())
                                {
                                    foreach (var buildingss in buildingsss)
                                    {
                                        <li class="sidebar-subitem">
                                            <a asp-controller="Room" asp-action="ListRoom" asp-route-buildingId="@buildingss.Id" class="sidebar-sublink">
                                                <i class="fa-solid fa-house" style="color: #0672e5;"></i>
                                                @buildingss.Name
                                            </a>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li class="sidebar-subitem">Không có tòa nhà nào</li>
                                }
                            </ul>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Facility" asp-action="ListFacility" aria-expanded="false">
                                <span>
                                    <i class="fa-solid fa-gears"></i>
                                </span>
                                <span class="hide-menu">Cơ sở vật chất</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Service" asp-action="ListService" aria-expanded="false">
                                <span>
                                    <i class="ti ti-menu"></i>
                                </span>
                                <span class="hide-menu">Dịch vụ</span>
                            </a>
                        </li>

                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Service" asp-action="ServiceRecord" aria-expanded="false">
                                <span>
                                    <i class="fa-solid fa-bolt"></i>
                                </span>
                                <span class="hide-menu"> <i class="fa-solid fa-plug-circle-bolt"></i> Chỉ số điện</span>
                            </a>
                        </li>

                        <li class="sidebar-item">
                            <a class="sidebar-link" asp-controller="Maintainance" asp-action="ListMaintainance" aria-expanded="false">
                                <span>
                                    <i class="fa fa-paper-plane"></i>
                                </span>
                                <span class="hide-menu">Danh sách yêu cầu</span>
                            </a>
                        </li>

                    </ul>

                </nav>

            </div>

        </aside>

        <div class="body-wrapper">

            <header class="app-header" style="background-color:  #3385ff">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <ul class="navbar-nav">
                        <li class="nav-item d-block d-xl-none">
                            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                                <i class="ti ti-menu-2"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                                <i class="ti ti-bell-ringing"></i>
                                <div class="notification bg-primary rounded-circle"></div>
                            </a>
                        </li>
                    </ul>
                    <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                            <li class="nav-item dropdown">
                                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    <img src="~/images/profile/user-1.jpg" alt="" width="50" height="50" class="rounded-circle">
                                </a>
                                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                                    <div class="message-body">
                                        <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-user fs-6"></i>
                                            <p class="mb-0 fs-3">My Profile</p>
                                        </a>
                                        <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-mail fs-6"></i>
                                            <p class="mb-0 fs-3">My Account</p>
                                        </a>
                                        <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-list-check fs-6"></i>
                                            <p class="mb-0 fs-3">My Task</p>
                                        </a>
                                        <a href="/Auth/Login" class="btn btn-outline-primary mx-3 mt-2 d-block " onclick="logout()">Đăng xuất</a>

                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                </nav>
            </header>
            <!--  Header End -->

            <div class="container-fluid">
                <link rel="stylesheet" href="~/css/styles.min.css" />
                <div class="container-fluid" style="margin-top: 1rem">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 center>@ViewData["Title"]</h1>
                        <style>
                            .btn-spacing > button {
                                margin-right: 10px; /* Tạo khoảng cách 10px giữa các nút */
                            }
                        </style>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success">Lưu</button>
                            <button class="btn btn-warning ms-2">Xuất file Excel</button>
                        </div>
                    </div>
                    <hr />
                    <!-- Notes -->
                    <!-- Lưu ý -->
                    <div class="alert alert-light border mb-3">
                        <strong style="color: red;">Lưu ý:</strong>
                        <ul class="mb-0">
                            <li>- Bạn phải gán dịch vụ thuộc loại điện cho khách thuê trước thì phần chỉ số này mới được tính cho phòng đó khi tính tiền.</li>
                            <li>- Đối với lần đầu tiên sử dụng phần mềm bạn sẽ phải nhập chỉ số cũ và mới cho tháng sử dụng đầu tiên, các tháng tiếp theo phần mềm sẽ tự động lấy chỉ số mới tháng trước làm chỉ số cũ tháng sau.</li>
                        </ul>
                    </div>

                    <div class="container mt-4">
                        <!-- Bộ lọc -->
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-3">
                                <label for="monthYear" class="form-label">Tháng/năm</label>
                                <input type="month" class="form-control" id="monthYear" value="2024-11">
                            </div>
                            <div class="col-md-3">
                                <label for="building" class="form-label">Nhà</label>
                                <select id="BuildingId" class="form-select">
                                    <option selected>Tất cả</option>
                                    <!-- Các tùy chọn khác -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="room" class="form-label">Phòng</label>
                                <select id="RoomId" class="form-select">
                                    <option selected>Tất cả</option>
                                    <!-- Các tùy chọn khác -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="roomStatus" class="form-label">Trạng thái phòng</label>
                                <select id="roomStatus" class="form-select">
                                    <option selected>Tất cả</option>
                                    <!-- Các tùy chọn khác -->
                                </select>
                            </div>
                            
                        </div>
                        <!-- Bảng dữ liệu -->
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nhà</th>
                                    <th>Phòng</th>
                                    <th>Khách thuê</th>
                                    <th>CS Điện Cũ</th>
                                    <th>CS Điện Mới</th>
                                    <th>Sử dụng</th>
                                    <th>Tính</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tầng 1</td>
                                    <td>2</td>
                                    <td>Nguyen Vy</td>
                                    <td><input type="number" class="form-control" value="53"></td>
                                    <td><input type="number" class="form-control" value="656"></td>
                                    <td class="text-end">603.0</td>
                                    <td><button class="btn btn-info btn-sm"><i class="fa-solid fa-calculator"></i></button></td>
                                </tr>
                                <tr>
                                    <td>Tầng 1</td>
                                    <td>3</td>
                                    <td></td>
                                    <td><input type="number" class="form-control" value="0"></td>
                                    <td><input type="number" class="form-control" value="0"></td>
                                    <td class="text-end">0.0</td>
                                    <td><button class="btn btn-info btn-sm"><i class="fa-solid fa-calculator"></i></button></td>
                                </tr>
                                <!-- Các dòng khác -->
                            </tbody>
                        </table>

                    <!-- Phân trang -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>Đang xem 0 đến 0 trong tổng số 0 mục</div>
                        <div>
                            <button class="btn btn-light" disabled>Trước</button>
                            <button class="btn btn-light" disabled>Tiếp</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/sidebarmenu.js"></script>
    <script src="~/js/app.min.js"></script>
    <script src="~/lib/apexcharts/dist/apexcharts.min.js"></script>
    <script src="~/lib/simplebar/dist/simplebar.js"></script>
    <script src="~/js/dashboard.js"></script>
    <script>
        

        $(document).ready(function () {
            loadRoom();
            loadBuilding();
            loadStatusRoom();
        })

        //Lấy UserId
        function getUserIdFromToken(token) {
            try {
                const tokenParts = token.split('.');
                const payload = JSON.parse(atob(tokenParts[1]));
                return payload.UserId;
            } catch (error) {
                console.error("Không mã hóa đc token:", error);
                return null;
            }
        }

        function loadBuilding() {
            const token = sessionStorage.getItem("token");
            //Lấy user id
            const userId = getUserIdFromToken(token);
            $.ajax({
                url: `https://localhost:7056/api/Building/GetBuildingsByUserId/${userId}`,// Sửa api lấy all building thành api này
                type: 'GET',
                dataType: 'json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                },
                success: function (response) {
                    renderBuilding(response);
                    displayBuildings(response); //Thêm cái này nữa
                },
                error: function (xhr, status, error) {
                    console.error("Có lỗi xảy ra:", error);
                }
            });
        }

        function renderBuilding(data) {
            var urlParams = new URLSearchParams(window.location.search);
            var buildingId = urlParams.get('buildingId');
            let html = `<option value="-1" ${buildingId <= 0 ? 'selected' : ''}>Tất cả</option>`;
            for (var item of data) {
                html += `<option value="${item.id}" ${buildingId == item.id ? 'selected' : ''}>${item.name}</option>`
            }
            $("#buildings").html(html);
        }

        //Hàm lấy list building theo UserId
        //-------------------------------------------------------
        function displayBuildings(buildings) {
            const sidebarContainer = $('.sidebar-submenu');

            // Clear previous content
            sidebarContainer.empty();

            if (buildings && buildings.length > 0) {
                // Update Sidebar
                buildings.forEach(building => {
                    sidebarContainer.append(`
                                                        <li class="sidebar-subitem">
                                                            <a href="/Room/ListRoom?buildingId=${building.id}" class="sidebar-sublink">
                                                                        <i class="fa-solid fa-house" style="color: #0672e5;"></i> ${building.name}
                                                            </a>
                                                        </li>
                                                    `);
                });
            } else {
                displayNoBuildingsMessage();
            }
        }
        function displayNoBuildingsMessage() {
            const sidebarContainer = $('.sidebar-submenu');
            const tableContainer = $('#buildingsContainer');

            // Notify in Sidebar
            sidebarContainer.empty();
            sidebarContainer.append(`
                                                <li class="sidebar-subitem">Không có tòa nhà nào</li>
                                            `);
        }


        function loadRoom() {
            $.ajax({
                url: 'https://localhost:7056/api/Room/GetAllRoom',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    renderRoom(response);
                },
                error: function (xhr, status, error) {
                    console.error("Có lỗi xảy ra:", error);
                }
            });
        }
        function renderRoom(data) {
            let html = ``;
            for (var item of data) {
                html += `<option value="${item.id}">${item.roomNumber}</option>`
            }
            $("#RoomId").html(html);
        }

        function loadStatusRoom() {
            $.ajax({
                url: 'https://localhost:7056/api/Room/GetAllStatus',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    renderStatus(response);
                },
                error: function (xhr, status, error) {
                    console.error("Có lỗi xảy ra:", error);
                }
            });
        }
        function renderStatusRoom(data) {
            let html = ``;
            for (var item of data) {
                html += `<option value="${item.id}">${item.description}</option>`
            }
            $("#roomStatus").html(html);
        }

    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


</body>

</html>